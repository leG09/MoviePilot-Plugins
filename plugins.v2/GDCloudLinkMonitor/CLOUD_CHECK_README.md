# 网盘限制检测功能说明

## 功能概述

GDCloudLinkMonitor 插件新增了网盘限制检测功能，可以在文件转移前自动检测网盘是否被限制，避免向被限制的网盘上传文件，并自动轮询到下一个可用的网盘目录。

## 功能特点

1. **自动检测**: 在文件转移前自动检测网盘状态
2. **智能轮询**: 当检测到网盘被限制时，自动选择下一个可用的网盘目录
3. **缓存机制**: 避免频繁检测，提高性能
4. **历史一致性**: 优先使用历史记录中的目录，保持同一剧集/电影系列在同一目录
5. **容错处理**: 当所有网盘都被限制时，会记录错误并跳过文件处理

## 配置说明

### 启用网盘限制检测
- **启用网盘限制检测**: 开启或关闭网盘限制检测功能
- **检测间隔(秒)**: 设置检测间隔时间，默认300秒（5分钟）

### CloudDrive CLI 配置
- **CloudDrive CLI路径**: 设置 clouddrive-cli 工具的完整路径
- **测试文件路径**: 设置用于检测的小文件路径

## 使用示例

### 1. 配置 CloudDrive CLI
确保 clouddrive-cli 工具可用，例如：
```bash
./clouddrive-cli -command=upload -file='/path/to/test.txt' -path="/gd10/"
```

### 2. 插件配置
在插件配置中设置：
- 启用网盘限制检测: ✅
- CloudDrive CLI路径: `/path/to/clouddrive-cli`
- 测试文件路径: `/path/to/test_file.txt`
- 检测间隔: 300

### 3. 监控目录配置
配置多个目标目录用于轮询：
```
/monitor/path:/gd1/,/gd2/,/gd3/
```

## 工作原理

1. **检测触发**: 当需要转移文件时，插件会检查目标网盘的状态
2. **缓存检查**: 如果距离上次检测时间小于设定间隔，使用缓存的状态
3. **实际检测**: 通过上传测试文件到目标网盘来检测状态
4. **状态判断**: 
   - 上传成功且输出包含"文件上传完成" → 网盘正常
   - 上传失败或超时 → 网盘被限制
5. **目录选择**: 
   - 优先使用历史记录中的目录（如果可用）
   - 否则使用轮询算法选择下一个可用目录
6. **错误处理**: 如果所有目录都被限制，记录错误并跳过文件

## 日志说明

插件会记录详细的检测日志：
- `检测网盘状态: [命令]` - 显示执行的检测命令
- `网盘 [路径] 状态正常` - 网盘检测正常
- `网盘 [路径] 被限制，错误信息: [错误]` - 网盘被限制
- `目标目录 [路径] 被限制，尝试下一个目录` - 轮询到下一个目录
- `所有目标目录都被限制，无法转移文件` - 所有目录都被限制

## 注意事项

1. **测试文件**: 建议使用小文件（如1KB的文本文件）作为测试文件，避免占用过多存储空间
2. **检测间隔**: 不要设置过短的检测间隔，避免频繁检测影响性能
3. **CLI工具**: 确保 clouddrive-cli 工具具有执行权限且路径正确
4. **网络环境**: 检测功能依赖网络连接，确保网络环境稳定
5. **权限问题**: 确保插件有权限执行外部命令

## 故障排除

### 检测失败
- 检查 clouddrive-cli 路径是否正确
- 确认测试文件是否存在
- 查看日志中的具体错误信息

### 轮询不生效
- 确认配置了多个目标目录
- 检查检测间隔设置是否合理
- 查看网盘状态缓存是否正确

### 性能问题
- 适当增加检测间隔时间
- 使用较小的测试文件
- 检查网络连接状况
